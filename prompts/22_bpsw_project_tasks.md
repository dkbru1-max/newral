# Проект BPSW: выполнение подзадач

## Контекст
Проект поиска контрпримера для теста BPSW (Baillie-PSW) требует особого подхода к распределению вычислений. Вместо монолитного задания, работа разбивается на множество специализированных подзадач, которые могут выполняться параллельно на разных узлах. Необходимо модернизировать систему, чтобы поддержать такой сценарий на примере проекта BPSW-Hunter.

## Новые требования
1. **Разбиение задачи на типы подзадач:** Серверный оркестратор должен уметь разбивать крупную задачу проекта BPSW на несколько типов подзадач. Например, проект может быть разделён на категории вычислений: `main_odds`, `mod_filter`, и другие этапы алгоритма. Каждая категория подзадач представляет отдельный скрипт или функцию и может генерировать множество экземпляров заданий. Оркестратор при старте проекта BPSW создает задания для каждого этапа:
   - Определяет общее количество необходимых подзадач каждого типа (возможно, на основе параметров проекта или пока просто распределяет равномерно).
   - Создает записи заданий в БД с пометкой типа (например, `type = 'main_odds'` или `'mod_filter'`) и статусом в очереди.
2. **Назначение скриптов и контроль хеша:** Вместо передачи исполняемого кода напрямую, каждое задание содержит ссылку на скрипт в хранилище MinIO и контрольную сумму (хеш) этого файла:
   - В БД или конфигурации для каждого типа подзадач хранится эталонный хеш соответствующего скрипта. Эти скрипты заранее загружены администратором на сервер (см. пункт 6).
   - При выдаче задания агенту, сервер отправляет только идентификатор задания, тип подзадачи, ссылку (URL) на скачивание скрипта из MinIO и ожидаемый хеш.
   - Агент, получив задачу BPSW, скачивает соответствующий скрипт и вычисляет его хеш (например, SHA-256). Если вычисленный хеш не совпадает с присланным сервером, агент отвергает задачу и уведомляет сервер о несоответствии (это защитит от повреждения или подмены кода).
   - Если хеш совпал, агент запускает скрипт на выполнение (подробности исполнения ниже).
3. **Ограничение на изменение кода:** Участник (владелец узла) не может изменять код вычислений. Скрипты хранятся только на сервере/MinIO, и их содержимое проверяется. Таким образом, даже если участник имеет физический доступ к файлу скрипта (например, может его увидеть на своём диске после скачивания), любые изменения приведут к несовпадению хеша и отказу выполнения. Это гарантирует целостность алгоритма поиска контрпримера BPSW и исключает возможность читерства (например, пропуска сложных вычислений).
4. **Выбор подзадач участником:** Добавить функциональность, позволяющую участникам выбирать, в выполнении каких типов подзадач они хотят участвовать:
   - В интерфейсе агента (или в портале от лица узла) добавить настройки для проектов, например, проект BPSW -> перечень типов подзадач с чекбоксами.
   - Участник может отметить галочками те типы, которые готов считать. Например, один узел может выполнять и `main_odds` и `mod_filter`, а другой – только `main_odds` из-за ограничений ресурсов.
   - При регистрации или обновлении этих предпочтений агент отправляет их на сервер (например, API-запрос `POST /agent/preferences` с данными: для проекта BPSW включены такие-то типы).
   - Сервер сохраняет эти предпочтения в базе (например, таблица или поле настроек в записи агента).
5. **Учет предпочтений при выдаче задач:** Оркестратор должен фильтровать задания по предпочтениям узлов:
   - Когда агент запрашивает новую задачу, сервер выбирает из очереди задание подходящего типа. Если у агента, скажем, разрешён только `main_odds`, ему не будут отправляться задачи типа `mod_filter`.
   - Если задач предпочтительного типа временно нет, возможно, агент будет ждать или сервер может прислать задание другого типа **только если** участник на это согласился.
   - В реализации можно добавить проверку: при выборе задания из очереди дополнительно проверять, входит ли `task.type` в список разрешённых типов данного агента. Если нет, пропустить и поискать другое.
6. **Хранение и обновление скриптов на сервере:** Все скрипты, необходимые для подзадач BPSW, хранятся централизованно:
   - Администратор размещает актуальные версии скриптов в специальной директории (напр. `/home/user/work/dev_inputs/`) на сервере. Эти скрипты представляют собой, к примеру, исполняемые Python-файлы или бинарные модули, реализующие логику `main_odds`, `mod_filter` и др.
   - При старте проекта или при обновлении скриптов администратор загружает файлы в MinIO (например, через админ-портал или напрямую). Название файлов и их местоположение известно системе, и в БД/конфигурации обновляется ожидаемый хеш.
   - Нужно разработать процедуру обновления: если скрипт обновлён (новая версия алгоритма), то админ перезаписывает файл и обновляет запись хеша. Новые задания будут выдаваться уже с новым хешем. Следует предусмотреть, что задания, ещё не выполненные старыми агентами с прежним хешем, будут либо перевыданы с новым хешем, либо отменены, чтобы избежать несоответствий.
7. **Выполнение скрипта на агенте:** Агент, убедившись в целостности скрипта, должен выполнить его:
   - Скрипт может быть, например, исполняемым Python-файлом. Агент запускает его в отдельном процессе, передав необходимые параметры (входные данные подзадачи). Желательно выполнять в изолированной среде (sandbox или ограниченный по ресурсам subprocess).
   - Во время выполнения агент может собирать лог вывода скрипта (stdout/stderr) для отладки или проверки – возможно, отправлять лог обратно по завершении или в случае ошибки.
   - По окончании работы скрипта агент собирает результаты (например, найденные числа, частичные результаты) из оговоренного выходного места (скрипт может писать в файл или возвращать кодом завершения). Затем агент отправляет результаты обратно на сервер, помечая подзадачу как выполненную или, если скрипт ничего не нашёл, как завершённую без нахождения контрпримера.
   - Если скрипт завершается с ошибкой или превышает время выполнения, агент должен сообщить об этом серверу, чтобы задание можно было повторить или пометить как неуспешное.

## Результат
Внедрение вышеперечисленных изменений позволит платформе Newral эффективно обслуживать проект BPSW-Hunter:
- **Масштабируемость:** Разбиение на подзадачи позволяет параллельно задействовать множество агентов, каждый на своей части работы.
- **Контроль целостности:** Проверка хеша гарантирует, что все узлы выполняют именно тот код, который предусмотрен проектом, без модификаций.
- **Гибкость участия:** Участники могут выбирать посильную для них работу (например, если у узла нет GPU, он может избегать подзадач, требующих GPU).
- **Обновляемость:** Администратор может обновлять алгоритмы поиска (скрипты) централизованно, и изменения сразу распространятся на новые задания.
- **Прозрачность:** Узлы-агенты выступают в роли "чёрных ящиков", выполняющих доверенный код. Пользователю не нужно вручную запускать или менять что-либо – система автоматически распределяет и собирает результаты.
