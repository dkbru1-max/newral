# Редизайн и улучшения клиента-агента

## Новый дизайн интерфейса
Агентское приложение получит обновлённый графический интерфейс (GUI) в современном стиле, оформленный в цветовой гамме платформы Newral. Основные задачи:
- **Единый стиль:** Использовать фирменные цвета и логотипы Newral, чтобы агент визуально ассоциировался с платформой. Применить современные элементы UI (плоский дизайн, аккуратные иконки, понятные шрифты).
- **Удобство:** Обеспечить интуитивно понятное расположение элементов. Например, главная панель может отображать статус и основную информацию (проект, задача, состояние), боковое меню — настройки и сведения об узле.
- **Адаптивность:** Учесть разные размеры экрана и масштаб. Интерфейс должен корректно отображаться как на небольшом ноутбуке, так и на дисплее сервера (который может запускаться без высокого разрешения).
- **Кроссплатформенность:** Проверить, что выбранные технологии GUI работают и на Windows (включая серверные редакции), и на Linux. Возможные варианты — использовать фреймворки вроде Qt (через bindings в Rust) или Electron (если часть агента может быть веб-базированной), либо штатные кроссплатформенные библиотеки UI для Rust.

## Сборка и CI через GitHub Actions
Необходимо настроить автоматическую сборку и релиз обновлённого агента:
- **CI Workflow:** Создать workflow для GitHub Actions, который будет запускаться при пуше в основную ветку или при создании релизной версии. В workflow включить шаги для установки зависимостей и сборки проекта.
- **Сборка под Windows и Linux:** Настроить matrix build, чтобы агент собирался под ключевые ОС. Особое внимание Windows: убедиться, что сборка проходит для Windows Server (понадобится cross-compilation или запуск runner на Windows). Решить возможные проблемы (например, зависимости GUI на Windows).
- **Тесты:** При наличии автоматических тестов – включить их в pipeline. Если GUI сложно протестировать автоматически, предусмотреть хотя бы сборку без падений.
- **Артефакты:** Настроить сохранение собранных бинарных файлов или установщиков. Например, использовать `actions/upload-artifact` или создавать релиз с прикреплением бинарников, чтобы участники могли скачать новый агент.
- **Отладка silent crash:** Если сейчас агент "тихо падает" на Windows Server, необходимо:
  - Добавить в код ловлю неотловленных исключений (например, std::panic::set_hook в Rust, чтобы логировать panic).
  - В местах возможных сбоев (инициализация GUI, доступ к ресурсам) добавить проверку окружения и отладочный вывод.
  - Протестировать запуск на реальной или виртуальной Windows Server ОС через Actions (например, GitHub Actions предоставляет Windows runner) или вручную, и проанализировать лог.
  - Исправить причину сбоя (возможные причины: отсутствие графической библиотеки, права доступа, отсутствие монитор/дисплей контекста для GUI на сервере и т.д. Может понадобиться режим headless или специальный флаг для GUI-библиотеки).

## Уникальный идентификатор агента
Каждый агент должен идентифицироваться уникально:
- **Генерация ID:** При первом старте приложения генерировать уникальный идентификатор узла (например, GUID/UUID). Этот идентификатор сохраняется локально (в файл конфигурации или в системный реестр, в зависимости от ОС).
- **Использование ID:** При подключении к серверу агент передаёт свой уникальный ID вместе с регистрационными данными. Сервер, получив его, либо регистрирует новый узел (если ID незнаком), либо обновляет информацию существующего (если агент переустанавливался, возможно, придётся воспринимать новый ID как новый узел).
- **Отображение:** В интерфейсе агента (например, в разделе "О программе" или в заголовке окна) отобразить сокращённую форму ID (первые 6-8 символов GUID), чтобы пользователь мог сообщить администратору свой идентификатор при необходимости.
- **Назначение репутации:** Репутация узла (в системе доверия Dr. Mann) теперь может привязываться к этому постоянному ID. Это значит, что даже если узел перезапустился, его история и репутационный счёт сохраняются по ID.

## Отображение текущего статуса
Интерфейс агента должен предоставлять пользователю актуальную информацию о работе:
- **Текущий проект:** Показывать, в рамках какого проекта сейчас работает агент. Если агент привязан к одному проекту (например, BPSW), можно просто отображать его имя. Если платформа позволяет одному агенту участвовать в нескольких проектах (не одновременно, а переключаясь), то отображать активный проект или при простое – "Ожидание задач".
- **Активная подзадача:** Отображать, какую конкретно задачу выполняет агент в данный момент. Например: "Выполняется: BPSW – подзадача main_odds #12345". Здесь может быть прогресс (если известен, например, 50% или этап 3/10), либо индикатор активности (спиннер).
- **Накопленная награда:** Отобразить счётчик очков или кредитов, заработанных узлом. Если в платформе Newral предусмотрена система вознаграждений за вычисления (например, рейтинг, баллы, токены), пользователь должен видеть свой текущий баланс/очки. Это повышает мотивацию: участник видит результаты своего вклада.
- **Состояние соединения:** Видимый индикатор связи с сервером. Например, зелёный значок или надпись "Подключено" при устойчивом соединении и обмене задачами. В случае проблем – красный значок "Отключено (ожидание подключения)". При попытке переподключения можно показывать мигающий статус или таймер. Это поможет пользователю понять, всё ли в порядке с сетью и сервером.

## Обработка блокировки агента
Администратор должен иметь возможность блокировать проблемные или подозрительные узлы. Агент должен корректно реагировать на блокировку:
- **Со стороны сервера:** В базе данных есть флаг (или статус) "заблокирован" для узла и поле "причина блокировки". Администратор через портал выставляет этот флаг и указывает причину (например, "отправка неправильных результатов", "подозрение на мошенничество").
- **При попытке получить задания:** Если агент заблокирован, сервер при обращении за новыми задачами может вернуть специальный ответ, сообщающий о блокировке (вместо списка задач). Либо сервер может не допускать подключения вовсе. Нужно продумать протокол: возможно, агент при WebSocket/HTTP соединении получает сообщение типа `{"status": "blocked", "reason": "Описание причины"}`.
- **Поведение агента при блокировке:** Получив уведомление о блокировке:
  - Агент должен прекратить выполнять текущие задачи. Если есть возможность, корректно завершить выполнение или вернуть незавершённые задания на сервер (чтобы их мог взять другой узел).
  - На экране агента отобразить крупное уведомление. Например: красный баннер или всплывающее окно: "Агент заблокирован администратором. Причина: ...". Все обычные элементы UI (статус, проект, прогресс) могут быть затенены/заблокированы.
  - Блокировать функциональность: не делать повторных попыток соединения, не запрашивать задачи. Можно периодически пробовать переподключиться (раз в несколько часов), вдруг блокировка снята, но не чаще, чтобы не нагружать сервер.
- **Статус Dr. Mann:** Если блокировка связана с системой доверия (то есть узел помечен автоматически или вручную как нарушитель), можно отобразить специальное сообщение. Название "Dr. Mann" – условное кодовое имя системы доверия, можно не показывать его пользователю напрямую. Вместо этого пользователь увидит "заблокирован за нарушение условий/недоверенный узел". Однако в админ-панели такой узел может помечаться именно как "Dr. Mann ID", т.е. блокировка по решению системы доверия.
- **Разблокировка:** Если блокировка снята (админ убрал флаг), агент при очередной попытке соединения должен снова войти в работу. При этом UI либо автоматически вернётся к нормальному состоянию, либо потребует перезапуска агента (упростить можно автоматическим переподключением).

## Пакетная выдача задач
Для повышения эффективности изменяем способ получения задач с сервера:
- **Запрос пачки задач:** Сейчас, предположительно, агент запрашивал по одной задаче. Нужно реализовать, чтобы агент мог получать сразу несколько заданий за раз. Например, отправлять запрос: "дайте до N задач" (где N в диапазоне 3–10, выбирается случайно или задан конфигурацией).
- **Очередь на агенте:** Агент получает список задач и складывает их во внутреннюю очередь выполнения. Он начинает выполнять первую задачу, а остальные ждут своей очереди. По мере выполнения (или если некоторые задачи могут выполняться параллельно на разных ядрах) – агент отмечает их выполненными и отправляет результаты.
- **Интервал между запросами:** После получения пачки задач, агент не должен сразу запрашивать новую, пока не обработает существенную часть или все. Введём паузу: после завершения текущей пачки, агент подождёт случайный промежуток времени от 15 до 180 секунд перед следующим запросом задач. Случайность распределяет нагрузку: разные узлы будут обращаться не синхронно.
- **Регулирование размера пачки:** Можно сделать так, что если у агента высокопроизводительное железо (много ядер, мощный GPU), он запрашивает больше задач за раз (ближе к 10). Если слабый – меньше (3-5). Либо пока сделать фиксированно, а оптимизацию оставить на потом.
- **Обработка конца очереди:** Если агент выполнил все задачи в пачке, а пауза ещё не истекла, он может либо прервать паузу и запросить раньше, либо дождаться тайм-аута. Это деталь реализации; важно, чтобы не было длительного простаивания, но и не было DDoS сервера постоянными запросами.
- **Отказоустойчивость:** Если в полученной пачке какая-то задача не удалась (ошибка, истёк таймаут), агент должен сообщить об этом серверу и перейти к следующей задаче из пачки. Неспособность выполнить одну задачу не должна останавливать всю пачку.
- **Протокол:** Нужно расширить API. Например, `GET /tasks?max=N` – возвращает массив задач. Или если WebSocket используется, добавить команду "FETCH_BATCH N".
- **Проверка работоспособности:** протестировать ситуацию с разными интервалами: при старте всех агентов, при длительной работе. Убедиться, что сервер правильно распределяет задания (не выдаёт одному агенту одну и ту же задачу дважды, даже если в очереди в этот момент мало задач), и что при отключении агента оставшиеся невыполненными задачи из его очереди возвращаются в пул (например, при разрыве соединения сервер может пометить незавершённые задачи как вновь доступные).

## Дополнительные улучшения
- **Логирование и отладка:** Внести улучшения в логи агента – например, писать в файл информацию о получении задач, выполнении, отправке результатов, соединении и ошибках. Это поможет пользователям и разработчикам понимать, что происходит (особенно в случае с новым механизмом пачек и блокировками).
- **Пауза агента:** Возможно, добавить в интерфейс кнопку "Приостановить вычисления", чтобы пользователь мог временно остановить получение новых задач (например, на время, когда ему нужен полный ресурс компьютера). При нажатии "Пауза" агент дождётся завершения текущих задач и не будет запрашивать новые, пока пользователь не нажмёт "Возобновить".
- **Улучшение UX:** Обратить внимание на мелочи: локализация интерфейса (если нужна), отображение времени работы, числа выполненных задач. Сделать агент приятным и информативным, чтобы участники охотнее его запускали.

Реализовав эти изменения, мы получим агент, который:
- Имеет современный и понятный интерфейс.
- Надёжно работает на различных ОС (включая серверные Windows).
- Эффективно использует сеть и сервер (благодаря пакетным задачам и паузам).
- Даёт пользователю прозрачность (видны проекты, задачи, награды) и контроль (пауза, информация о блокировке).
- Легко обновляется и отслеживается через CI/CD.
