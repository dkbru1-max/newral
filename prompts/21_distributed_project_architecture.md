# Распределённая архитектура проектов

## Цель
Обеспечить полную изоляцию данных каждого проекта в системе Newral, присвоив каждому проекту собственное пространство хранения в базе данных и в хранилище файлов.

## Описание изменений
1. **GUID для каждого проекта:** При создании проекта генерируется уникальный идентификатор (GUID). Этот GUID будет использоваться для именования связанных ресурсов (схемы БД, папки в MinIO и т.д.), а также как основной идентификатор проекта во всей системе.
2. **Отдельная схема PostgreSQL на проект:** Для данных каждого проекта создаётся своя схема в PostgreSQL. Все таблицы, относящиеся к проекту (задания, результаты, метрики и пр.), хранятся в этой отдельной схеме. Главная (общая) схема БД при этом содержит только глобальные таблицы: список проектов, пользователей, общие настройки и т.д. Это обеспечивает уровень изоляции – данные одного проекта не смешиваются с данными другого.
3. **Выделенная область в MinIO:** В объектном хранилище (MinIO) для каждого проекта создаётся отдельное пространство хранения – либо отдельный бакет, либо папка (префикс внутри общего бакета), названная по GUID проекта. Все входные данные и результаты, связанные с проектом, сохраняются в этой области, что предотвращает перепутывание или несанкционированный доступ между проектами.
4. **Управление проектами через основную схему и API:** Основная схема БД управляет перечнем проектов и их свойствами. Добавляются соответствующие API-эндпойнты в портале для создания нового проекта, удаления или изменения существующего. При создании проекта сервер должен:
   - Сгенерировать GUID и добавить запись о новом проекте в таблицу проектов (в основной схеме БД) с указанием его GUID, названия и прочих метаданных.
   - Создать новую схему в базе данных, уникальную для этого проекта (например, именовать схему по GUID или по шаблону `project_<GUID>`).
   - Создать внутри этой схемы необходимые таблицы (шаблон структуры можно заранее определить, аналогично структуре проекта Demo).
   - Инициализировать в MinIO новую папку или бакет для хранения файлов данного проекта.
5. **Проект Demo (ID=0):** Специальный "нулевой" проект Demo остаётся встроенным проектом по умолчанию. Для него также должна быть выделена собственная схема (например, `demo` или `project_0`) и директория в MinIO. Проект Demo не может быть удалён или изменён пользователем — он служит для демонстрации и тестирования. В интерфейсе портала такой проект может отображаться особым образом (пометка "Embedded Demo") и иметь ограничения на редактирование.
6. **Настройка прав доступа:** Необходимо убедиться, что приложение корректно обращается к нужной схеме при выполнении операций. Можно использовать либо явное указание схемы при запросах, либо устанавливать `search_path` соединения с БД на схему текущего проекта. Это гарантирует, что запросы, выполняемые в контексте проекта, не затронут данные других проектов. Также стоит предусмотреть разграничение прав в БД: например, создать роль для каждой схемы или использовать единый аккаунт с доступом ко всем схемам, если приложение полностью контролирует запросы.
   
## Шаги реализации
1. **Миграция базы данных:** Разработать и выполнить миграции, которые создадут:
   - Таблицу `projects` в основной (public) схеме, если её ещё нет. Поля могут включать: `id` (первичный ключ, может быть GUID или числовой ID), `guid` (уникальный идентификатор проекта, тип UUID), `name` (название проекта), `description`, `created_at` и т.д.
   - Отдельные схемы для уже существующих проектов. Например, для Demo-проекта создать схему `project_0` или аналогичную и перенести туда данные, относящиеся к демо-заданиям.
   - Обновить существующие внешние ключи/ссылки, если данные перемещаются между схемами.
2. **Изменение серверного кода (API):** Внедрить логику создания нового проекта:
   - При вызове создания проекта через портал (новый эндпойнт, например, `POST /projects`), backend генерирует GUID (например, с использованием функции БД `gen_random_uuid()` или на уровне приложения) и сохраняет проект в таблицу `projects`.
   - Затем выполняет создание схемы в БД (SQL-команда `CREATE SCHEMA` с именем, основанным на GUID или ID проекта).
   - Выполняет набор SQL-команд для создания внутри этой схемы всех необходимых таблиц (можно автоматизировать через миграции или скрипт, который принимает имя схемы и создаёт структуру).
   - Создаёт бакет или префикс в MinIO. Возможный подход: использовать API MinIO (S3 API) для программного создания бакета `<GUID>` или папки внутри общего бакета, если политика хранения — “один бакет на всё”.
3. **Рефакторинг доступа к данным:** Просмотреть участки кода, где выбираются или сохраняются данные проектов (например, получение списка задач, результатов). Ввести привязку к схеме:
   - Например, при запросе задач конкретного проекта, выполнить `SET search_path TO project_schema` или использовать полные имена таблиц `project_schema.table_name`.
   - Учесть, что некоторые запросы (например, к глобальным таблицам пользователей или проектов) должны по-прежнему идти в основную схему.
   - Можно реализовать в коде уровень абстракции, где при создании ORM-сессии или конструировании SQL учитывается текущий проект (например, хранить в сессии `current_project_schema`).
4. **Интеграция с MinIO:** Обновить модули, отвечающие за загрузку и выгрузку файлов:
   - При сохранении файла (например, входные данные задачи или результат вычисления) формировать путь вида `<project_guid>/<filename>` если используется единый бакет, либо выбирать бакет по имени GUID.
   - Аналогично, при скачивании – использовать GUID проекта из контекста задачи, чтобы найти файл.
   - Проверить права доступа MinIO: возможно, имеет смысл выделить учётные данные или политики доступа по проектам (хотя, вероятно, достаточно и простой организации по папкам).
5. **Особый случай Demo-проекта:** Убедиться, что после разделения на схемы проект Demo продолжает работать. Возможно, временно скрипты и задачи демо-проекта останутся в основной схеме. Необходимо перенести их в новую схему Demo и изменить код, который мог быть захардкожен на старую структуру.
   - Например, если демо-данные (задачи) раньше хранились в общих таблицах, нужно перенести их в таблицы внутри схемы демо-проекта.
   - В коде, где создаётся демо-проект при инициализации системы, теперь нужно создать схему и записи через общий механизм (как для обычных проектов).
6. **Тестирование и верификация:** После внедрения:
   - Создать несколько проектов через интерфейс или напрямую через API. Убедиться, что для каждого создана своя схема в БД и папка в MinIO.
   - Запустить задачи в разных проектах и проверить, что данные сохраняются в правильных таблицах (например, задача проекта A не появляется в таблицах проекта B).
   - Проверить, что удаление проекта (если функциональность предусмотрена) удаляет или помечает на удаление соответствующую схему и данные (возможно, физически схему можно не удалять сразу, а помечать проект как архивный).
   - Убедиться, что безопасность не нарушена: попытка запросить данные другого проекта (например, изменив GUID в запросе от клиента) не приведёт к утечке данных, так как сервер жёстко привязан к своей схеме при обработке запроса.
