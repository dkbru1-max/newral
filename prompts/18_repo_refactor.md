Используй текущее состояние репозитория и результаты MVP. Цель: улучшить структуру кода проекта Newral, устранив проблемные места, чтобы облегчить дальнейшую разработку (в том числе с помощью Codex).

1) **Анализ и выявление узких мест**: Пройди по коду всех сервисов и компонентов, чтобы найти участки, усложняющие поддержку.
   - Обрати внимание на дублирование кода между сервисами (например, повторяющиеся модели данных, конфигурация, подключение к БД или Kafka). Выяви такие повторяющиеся фрагменты для последующего выноса в общие модули.
   - Найди слишком громоздкие функции или файлы: если в одном модуле сосредоточена чрезмерная логика (бизнес-логика вперемешку с API, инициализацией и т.п.), пометь это место для рефакторинга.

2) **Модульность и переиспользование**: Раздели код на логические модули и вынеси общие части.
   - Создай общий модуль/библиотеку (в рамках монорепозитория) для общих компонентов: например, `common` для работы с БД, утилит, моделей, конфигов. Перенеси туда повторяющийся код из `services/*`, чтобы источником истины был один файл/модуль.
   - Внутри каждого сервиса раздели слои ответственности: отдельно файл/пакет для REST/API эндпойнтов, отдельно для бизнес-логики (service/manager), отдельно для работы с данными (database/repository). Это упростит восприятие и тестирование.
   - Если некоторые сервисы сейчас слишком мелкие по функциональности, рассмотри возможность их объединения или укрупнения модулей. Например, если `validator-service` и `scheduler-service` тесно связаны, можно временно объединить их логику под одним сервисом (или хотя бы в одном репозитории) до тех пор, пока функционал не вырастет. Цель – снизить количество отдельных компонентов, чтобы Codex/разработчикам было проще поддерживать целостную картину.

3) **Тестирование и качество**: Добавь недостающие тесты и инструменты для поддержания качества кода.
   - Покрыть ключевые модули юнит-тестами: например, логику планировщика задач, обработку результатов песочницы, расчёт метрик доверия (trust), API основных эндпойнтов. Цель – поймать регрессии при будущих изменениях.
   - Добавь интеграционные тесты для сценариев «сквозного» выполнения: постановка задачи -> выполнение агентом -> получение результата. Можно реализовать скрипт или тест, запускающий локально все сервисы (например, с помощью Docker Compose) и выполняющий тестовый цикл задачи, проверяя конечный результат.
   - Внедри проверку стиля/статического анализа: например, для Python-сервисов включи линтер (flake8/black) и type hints с mypy, для Rust-агента – `cargo fmt`/`clippy`. Это стандартизирует кодовую базу и уменьшит количество мелких исправлений, отвлекающих от сути.

4) **Рефакторинг проблемных участков**: По итогам анализа п.1, произведи точечные улучшения в коде.
   - Разбей слишком большие функции на более мелкие, понятные по назначению. Каждая функция/метод должна выполнять одно определённое дело. Например, если есть монолитная функция обработки задачи, выдели из неё части: обработка входных данных, выполнение, сохранение результатов – в отдельные подфункции.
   - Переименуй переменные, функции и модули, если их названия не очевидны. Ясные названия облегчат работу Codex и новых разработчиков: лучше `assign_task_to_agent()` чем `process()` и т.д.
   - Удали или изолируй временные заглушки и deprecated-код, оставшийся от раннего MVP. Всё, что не используется, должно быть удалено, либо помечено явным комментарием как временное, чтобы ИИ не тратил контекст на устаревшее.
   - Добавь поясняющие комментарии в "шапки" и по по всему коду, где это нужно.

5) **Документация изменений**: Обнови документацию по проекту в соответствии с проведённым рефакторингом.
   - В файле README.md опиши новую структуру, и как теперь запускать/отлаживать проект. Укажи все важные изменения.
   - Добавь docs/REFACTORING_NOTES.md (или раздел в существующей документации) с описанием выявленных проблем и принятых мер по улучшению. Перечисли ключевые рефакторинги: «выделено общая библиотека для ..., объединены сервисы ..., добавлены тесты ...». Это поможет в будущем понять причины изменений.
   - Убедись, что после рефакторинга `docker-compose up -d --build` и другие команды разработки должны работать штатно. Обнови инструкции, если что-то изменилось (например, убран сервис – убрать его упоминание). docker-compose up -d --build долго выполняется, лучше сам скажи когда мне её нужно запускать - я сам проверю.
