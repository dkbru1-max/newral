name: Build Windows Agent

on:
  workflow_dispatch:
  push:
    tags:
      - "agent-v*"

jobs:
  build-windows:
    runs-on: windows-latest
    env:
      HAS_GPG_KEY: ${{ secrets.GPG_PRIVATE_KEY != '' }}
      GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
      GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build agent
        run: cargo build --release --manifest-path client/agent/Cargo.toml --features gui

      - name: Package artifacts
        run: |
          $exe = "client/agent/target/release/newral-agent.exe"
          $zip = "client/agent/target/release/newral-agent-windows.zip"
          Compress-Archive -Path $exe -DestinationPath $zip -Force
          Get-FileHash $exe -Algorithm SHA256 | ForEach-Object { "$($_.Hash)  newral-agent.exe" } | Out-File "client/agent/target/release/newral-agent.exe.sha256" -Encoding ascii

      - name: Import GPG key (optional)
        if: env.HAS_GPG_KEY == 'true'
        run: |
          $key = "${{ env.GPG_PRIVATE_KEY }}"
          $pass = "${{ env.GPG_PASSPHRASE }}"
          $key | gpg --batch --yes --passphrase $pass --import

      - name: Sign artifacts (optional)
        if: env.HAS_GPG_KEY == 'true'
        run: |
          $pass = "${{ env.GPG_PASSPHRASE }}"
          gpg --batch --yes --passphrase $pass --armor --detach-sign client/agent/target/release/newral-agent.exe
          gpg --batch --yes --passphrase $pass --armor --detach-sign client/agent/target/release/newral-agent-windows.zip
          gpg --batch --yes --passphrase $pass --armor --detach-sign client/agent/target/release/newral-agent.exe.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: newral-agent-windows
          path: |
            client/agent/target/release/newral-agent.exe
            client/agent/target/release/newral-agent.exe.sha256
            client/agent/target/release/newral-agent-windows.zip
            client/agent/target/release/newral-agent.exe.asc
            client/agent/target/release/newral-agent-windows.zip.asc
            client/agent/target/release/newral-agent.exe.sha256.asc

      - name: Release artifact
        if: startsWith(github.ref, 'refs/tags/agent-v')
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            client/agent/target/release/newral-agent.exe
            client/agent/target/release/newral-agent.exe.sha256
            client/agent/target/release/newral-agent-windows.zip
            client/agent/target/release/newral-agent.exe.asc
            client/agent/target/release/newral-agent-windows.zip.asc
            client/agent/target/release/newral-agent.exe.sha256.asc
